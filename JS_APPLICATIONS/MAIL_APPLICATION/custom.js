const emailData = [
		{title:'inbox', id:0,
		 sub_list:[
		     {id: 10 ,title:'mail from vipro 10', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com10", Name: "arvind 10"},
				      To: [{Email: "arvind.depex@gmail.com10",Name: "arvind 10"}],
				      Subject: "Greetings from Mailjet 10.",
				      TextPart: "My first Mailjet email10"
				    }
			    ]
             },
			 {id: 20, title:'mail from vipro 20', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com20", Name: "arvind20"},
				      To: [{Email: "arvind.depex@gmail.com20",Name: "arvind20"}],
				      Subject: "Greetings from Mailjet.20",
				      TextPart: "My first Mailjet email20"
				    }
			    ]
             },
             {id: 30, title:'mail from vipro30', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com30", Name: "arvind30"},
				      To: [{Email: "arvind.depex@gmail.com30",Name: "arvind30"}],
				      Subject: "Greetings from Mailjet.30",
				      TextPart: "My first Mailjet email30"
				    }
			    ]
             },
             {id: 40, title:'mail from vipro40', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com40", Name: "arvind40"},
				      To: [{Email: "arvind.depex@gmail.com40",Name: "arvind40"}],
				      Subject: "Greetings from Mailjet.40",
				      TextPart: "My first Mailjet email40"
				    }
			    ]
             },
             {id: 50, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com50", Name: "arvind50"},
				      To: [{Email: "arvind.depex@gmail.com50",Name: "arvind50"}],
				      Subject: "Greetings from Mailjet.50",
				      TextPart: "My first Mailjet email50"
				    }
			    ]
             },
		 ]
		},
		{title:'sent item', id:1,
		 sub_list:[
		     {id: 11 ,title:'mail from vipro11', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com11", Name: "arvind11"},
				      To: [{Email: "arvind.depex@gmail.com11",Name: "arvind11"}],
				      Subject: "Greetings from Mailjet.11",
				      TextPart: "My first Mailjet email 11"
				    }
			    ]
             },
			 {id: 21, title:'mail from vipro21', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com21", Name: "arvind21"},
				      To: [{Email: "arvind.depex@gmail.com21",Name: "arvind21"}],
				      Subject: "Greetings from Mailjet.21",
				      TextPart: "My first Mailjet email21"
				    }
			    ]
             },
             {id: 31, title:'mail from vipro31', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com31", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com31",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.31",
				      TextPart: "My first Mailjet email31"
				    }
			    ]
             },
             {id: 41, title:'mail from vipro 41', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com41", Name: "arvind41"},
				      To: [{Email: "arvind.depex@gmail.com41",Name: "arvind41"}],
				      Subject: "Greetings from Mailjet.41",
				      TextPart: "My first Mailjet email41"
				    }
			    ]
             }
             
		 ]
		},
		{title:'favourite', id:2,
		 sub_list:[
		     {id: 12 ,title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
			 {id: 22, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
             {id: 32, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
             {id: 42, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             }
		 ]
		},
		{title:'Stared', id:3,
		 sub_list:[
		     {id: 13 ,title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
			 {id: 23, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
             {id: 33, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
             {id: 43, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             },
             {id: 53, title:'mail from vipro', stared:false, read:false, deleted:false, favourite:false, 
		      messages:[
				    { From: { Email: "arvind.depex@gmail.com", Name: "arvind"},
				      To: [{Email: "arvind.depex@gmail.com",Name: "arvind"}],
				      Subject: "Greetings from Mailjet.",
				      TextPart: "My first Mailjet email"
				    }
			    ]
             }
		 ]
		},
	]

emailData.map(d => d.sub_list.map(s => s.title = `${s.title} with id: ${s.id} in ${d.title}` ))
const data = (localStorage.getItem('localData') === null) ? [...emailData]:JSON.parse(localStorage.getItem('localData'));
console.log(data, 'data')

const main_list = document.querySelector('.main_list');
const sub_list = document.querySelector('.sub_list');
const description_block = document.querySelector('.description_block');
const actions = document.querySelector('.actions');



//loop over main list item ----------
function loadDOM(){ 
	data.forEach((mainList)=> createMainList(mainList));
	main_list.children[0].classList.add('active', 'text-white')
}


//render Main List  ---------------
function createMainList(list){
    mCount = unReadMailsCount(list);
	let liItem = document.createElement('li');
	liItem.setAttribute('id',list.id);
	liItem.innerHTML = `<sup class="badge badge-danger">${mCount} </sup> ${list.title}`;
	main_list.appendChild(liItem);

}

// unread mails count -----------
function unReadMailsCount(list){
	const unReadMails = list.sub_list.filter(v => v.read === false);
	return unReadMails.length; 
}

// click on main list item ----------
main_list.addEventListener('click',(e)=> {
	if(e.target && e.target.nodeName == "LI") { 
		if(!e.target.classList.contains('active')) {
			const getItem = data.find(v => v.id === Number(e.target.id));
			[...main_list.children].map(ch => {if(ch.id != e.target.id) ch.classList.remove('active', 'text-white')});
			e.target.classList.add('active', 'text-white');
			loadSubList(getItem.sub_list);
			document.querySelector('[job="selectall"]').checked = false;
		}
	}
})


// render sub list function ---------
function loadSubList(item){
	if(Array.from(sub_list.children).length > 0){Array.from(sub_list.children).forEach(l=> l.remove()) }
    item.forEach((v) => createSubList(v))
}


//create Sub List DOM ---------------
function createSubList(sublist){
	let readUnreadClass = sublist.read ? 'read' : 'unread';
	let favClass = sublist.stared ? 'badge-warning' : 'badge-secondary';
	let liItem = document.createElement('li');
	liItem.classList.add(readUnreadClass);
	liItem.setAttribute('id', sublist.id);
	liItem.innerHTML = `<input type="checkbox" name="" class="mr-2" job="select"> 
            <span class="mr-5" job="subtitle"> Title: ${sublist.title} </span>
            <span class="mr-1 badge badge-primary moveTo" job="move"> Move To
            	<div class="movelist"> 
            		${data.filter((d)=> d.id !== Number(document.querySelector('.main_list li.active').id))
            		.map((d)=> `<div id="${d.id}" onclick="moveToOther(event)">${d.title}</div>` )}
            	</div> 
            </span>
            <span class="mr-1 badge badge-secondary ${favClass}" job="favourite">Favourite </span> 
            <span class="badge badge-danger" job="delete">Delete </span>`;
	sub_list.appendChild(liItem);

	liItem.addEventListener('click',(e) => {
		if(e.target.getAttribute('job') == 'subtitle'){
			[...sub_list.children].filter(child=> child != e.target).map(sb => sb.classList.remove('active_li'));
			e.target.parentElement.classList.remove('read');
			e.target.parentElement.classList.add('active_li');
			e.target.parentElement.classList.remove('unread');

			data.map(d => d.sub_list.map(s => {
				if(s.id === Number(e.target.parentElement.id)) s.read = true;
			}));
            updateUnReadMailCount();
			localStorage.setItem('localData',JSON.stringify(data))
			loadDescBlock(sublist.messages[0]);
		}

		// delete mail -----
		if(e.target.getAttribute('job') == 'delete'){
			let elem = e.target.parentElement
			deleteMail(elem, sublist);
			updateUnReadMailCount();
		}

		// Favourite mail -----
		if(e.target.getAttribute('job') == 'favourite'){
			[...sub_list.children].map(l=> {if(Number(l.id) === Number(e.target.parentElement.id)){
				e.target.classList.toggle('badge-warning')
			}});

			data.map((d,i) => d.sub_list.map((sl,si) => {
				if(sl.id === sublist.id) sl.stared = !sl.stared;
			}));
			localStorage.setItem('localData',JSON.stringify(data));
		}

		// move mail
		if(e.target.getAttribute('job') == 'move'){
			e.target.children[0].classList.toggle('d-block')
		}

		// select mail
		if(e.target.getAttribute('job') == 'select'){
			if([...sub_list.children].every(c => c.children[0].checked == false)){
				document.querySelector('[job="selectall"]').checked = false;
			}
		}

	})
}

//delete mail --------
function deleteMail(elem, sublist){
	[...sub_list.children].map(l=> {if(Number(l.id) === Number(elem.id)) l.remove()});

	const subNode = data.find( d=> d.id === Number(document.querySelector('.main_list li.active').id)).sub_list;
	subNode.map((sl,si) => {
		if(sl.id === sublist.id) subNode.splice(si,1)
	})
	localStorage.setItem('localData',JSON.stringify(data));
}

// load description block ----------
function loadDescBlock(desc){
	let checkActiveClass = Array.from(sub_list.children).some(v=> v.classList.contains('active_li'))
	if(!checkActiveClass){
		description_block.innerHTML=`click to a mail list to open and read the mail.`
	}
	else{
		description_block.classList.add('active')
		description_block.innerHTML=`<p> <b>From: </b>  ${desc.From.Email} </p>
          <p> <b>To: </b>  ${desc.To[0].Name} </p>
          <p> <b>Subject: </b>  ${desc.Subject} </p>
          <p> <b>Description: </b> ${desc.TextPart} </p>`
	}
	
}

// update unread mail count --------
function updateUnReadMailCount(){
	data.map((d,i)=> {
		const un = d.sub_list.filter(sl => sl.read === false);
		[...main_list.children][i].children[0].innerText = un.length
	})
}


// select All, moveall, favourite all and delete all actions ---------
actions.addEventListener('click', (e)=>{
    let element = e.target ;

    // select All
    if(element.getAttribute('job') === 'selectall' && element.checked == true) {
    	[...sub_list.children].forEach(c => c.children[0].checked = true)
    }
    else if(element.getAttribute('job') === 'selectall' && element.checked == false) {
    	[...sub_list.children].forEach(c => c.children[0].checked = false);
    }


    // delete All
    if(element.getAttribute('job') === 'deleteall'){
    	let notAnySelected = [...sub_list.children].every(c=>c.children[0].checked == false);
        if(notAnySelected){alert('Please select atleast one mail to perform actions.')}
        else{
        	let checkedItems = [...sub_list.children].filter(v => v.children[0].checked == true );
	    	checkedItems.map(i=>i.remove());

	    	// delete from data
	    	const currId = Number(document.querySelector('.main_list li.active').id)
	    	checkedItems.map(c => {
	    		const findItem = data.find(v=> v.id === currId)
	    		.sub_list.splice(data.find(v=> v.id === currId).sub_list.findIndex(x => x.id === Number(c.id)),1);
	    	})
	    	localStorage.setItem('localData',JSON.stringify(data));	
	    	document.querySelector('[job="selectall"]').checked = false;
			updateUnReadMailCount();

        }
    }

    // Mark as favourite All
	if(element.getAttribute('job') === 'favall'){
		let notAnySelected = [...sub_list.children].every(c=>c.children[0].checked == false);
        if(notAnySelected){alert('Please select atleast one mail to perform actions.')}
        else{
        	let checkedItems = [...sub_list.children].filter(v => v.children[0].checked == true );
			checkedItems.map(i=>{
				i.children[3].classList.toggle('badge-warning');
				i.children[0].checked = false;
			});

			// mark in data
			const currId = Number(document.querySelector('.main_list li.active').id)
			checkedItems.map(c => {
				const toggleVal = (data.find(v=> v.id === currId).sub_list.find(l=> l.id === Number(c.id)).stared)
				data.find(v=> v.id === currId).sub_list.find(l=> l.id === Number(c.id)).stared = !toggleVal;
			})
			localStorage.setItem('localData',JSON.stringify(data));	
	    	document.querySelector('[job="selectall"]').checked = false;
        }
		
	}

})


// move mail to other ---------
function moveToOther(e){
	const itemToMove = data.find(d => d.id === Number(document.querySelector('.main_list li.active').id))
	const finalItemToMove = itemToMove.sub_list.find(v=> v.id === Number(e.target.parentElement.parentElement.parentElement.id))
	data.find(d=> d.id === Number(e.target.id)).sub_list.push(finalItemToMove);

	const elem = e.target.parentElement.parentElement.parentElement;
	deleteMail(elem, finalItemToMove);
	updateUnReadMailCount();
}


//initial DOM render ----------
document.addEventListener('DOMContentLoaded', ()=>{
	loadDOM();
	const getSubItem = data.find(v => v.id === 0);
	loadSubList(getSubItem.sub_list);
	loadDescBlock();
})

// clear or reset all data of web ---
document.querySelector('#reset').addEventListener('click',()=>{
	localStorage.removeItem('localData');
	location.reload();
}) 


